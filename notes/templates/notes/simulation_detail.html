{% extends "notes/base.html" %}
{% block title %}Online Test - NextGen Physics{% endblock %}
{% block content %}

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold text-primary mb-3">üß≠ Questions</h5>
          <div id="question-list" class="d-flex flex-wrap gap-2">
            {% for question in questions %}
              <button
                class="btn btn-outline-secondary btn-sm question-nav"
                id="btn-q{{ question.id }}"
                onclick="showQuestion({{ forloop.counter0 }})"
              >
                {{ forloop.counter }}
              </button>
            {% endfor %}
          </div>

          <hr />
          <div class="text-center">
            <div class="fs-5 fw-bold text-danger" id="timer">00:00</div>
            <small class="text-muted">Time Remaining</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Test Area -->
    <div class="col-md-9">
      <h2 class="text-center text-primary mb-4">‚öõÔ∏è Physics Online Test</h2>

      <form id="test-form" onsubmit="event.preventDefault(); submitTest();">
        {% csrf_token %}
        <input type="hidden" id="sessionId" value="{{ session.id }}" />

        {% for question in questions %}
          <div
            class="card mb-4 shadow-sm border-0 question-card"
            id="q{{ forloop.counter0 }}"
            {% if not forloop.first %}style="display:none;"{% endif %}
          >
            <div class="card-body">
              <h5>{{ forloop.counter }}. {{ question.question_text|safe }}</h5>

              {% if question.image %}
                <img
                  src="{{ question.image.url }}"
                  alt="Question Image"
                  class="img-fluid my-2 rounded"
                />
              {% endif %}

              <!-- ‚úÖ Fixed Option Loop -->
              <div class="ms-3 mt-3">
                {% for opt in "A,B,C,D"|cut:"," %}
                  <label class="d-block mb-2">
                    <input
                      type="radio"
                      name="{{ question.id }}"
                      value="{{ opt }}"
                      class="form-check-input me-2"
                      onchange="saveProgress('{{ question.id }}', '{{ opt }}')"
                    />
                    {{ opt }}.
                    {% if opt == "A" %}
                      {{ question.option_a }}
                    {% elif opt == "B" %}
                      {{ question.option_b }}
                    {% elif opt == "C" %}
                      {{ question.option_c }}
                    {% elif opt == "D" %}
                      {{ question.option_d }}
                    {% endif %}
                  </label>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-3">
          <button
            type="button"
            class="btn btn-outline-primary"
            onclick="prevQuestion()"
          >
            ‚¨ÖÔ∏è Prev
          </button>
          <button
            type="button"
            class="btn btn-outline-primary"
            onclick="nextQuestion()"
          >
            Next ‚û°Ô∏è
          </button>
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success btn-lg">
            ‚úÖ Submit Test
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ====================== JavaScript ====================== -->
<script>
  let timeLeft = 1800; // 30 minutes
  let currentIndex = 0;
  const questionCards = document.querySelectorAll(".question-card");
  const totalQuestions = questionCards.length;
  const sessionId = document.getElementById("sessionId").value;

  // ------------------ TIMER ------------------
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s < 10 ? "0" : ""}${s}`;
  }

  function startTimer() {
    const timerDisplay = document.getElementById("timer");
    const countdown = setInterval(() => {
      timeLeft--;
      timerDisplay.textContent = formatTime(timeLeft);
      if (timeLeft <= 0) {
        clearInterval(countdown);
        submitTest();
      }
    }, 1000);
  }
  window.onload = startTimer;

  // ------------------ NAVIGATION ------------------
  function showQuestion(index) {
    questionCards[currentIndex].style.display = "none";
    questionCards[index].style.display = "block";
    currentIndex = index;
  }

  function nextQuestion() {
    if (currentIndex < totalQuestions - 1) showQuestion(currentIndex + 1);
  }

  function prevQuestion() {
    if (currentIndex > 0) showQuestion(currentIndex - 1);
  }

  // ------------------ AUTO-SAVE ------------------
  function saveProgress(questionId, selectedOption) {
    fetch("/save_progress/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        session_id: sessionId,
        question_id: questionId,
        selected_option: selectedOption,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "success") {
          const btn = document.getElementById(`btn-q${questionId}`);
          btn.classList.remove("btn-outline-secondary");
          btn.classList.add("btn-success");
        }
      })
      .catch((err) => console.error("Save error:", err));
  }

  // ------------------ SUBMIT TEST ------------------
  function submitTest() {
    fetch("/submit_test/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session_id: sessionId }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "success") {
          alert(
            `‚úÖ Test Submitted!\nScore: ${data.score.toFixed(
              2
            )}%\nAccuracy: ${data.accuracy.toFixed(2)}%`
          );
          window.location.href = `/result/${sessionId}/`;
        } else {
          alert("‚ö†Ô∏è Error: " + data.message);
        }
      })
      .catch((err) => {
        console.error("Submit error:", err);
        alert("Something went wrong while submitting the test.");
      });
  }
</script>

{% endblock %}
